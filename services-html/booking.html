<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Book a Repair - ElectroFix</title>
    <link rel="stylesheet" href="../services-css/booking.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <script
      type="module"
      src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"
    ></script>
    <script
      type="module"
      src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"
    ></script>
  </head>
  <body>
    <div id="loadingScreen" class="loading-screen">
      <div class="spinner"></div>
      <p>Loading Please Wait...</p>
    </div>

    <section class="booking-section">
      <div class="booking-container">
        <div class="booking-card">
          <div class="booking-image-container">
            <img
              src="../images/booking.jpg"
              alt="Technician working on a circuit board."
              class="booking-image"
            />
          </div>
          <div class="booking-form-container">
            <h2 class="form-title">Fix Your Device Now!</h2>
            <p class="form-subtitle">
              Hey! Please check, before submitting everything is looks correct!
            </p>

            <div class="selected-service-card">
              <p id="selectedCategoryText">Loading...</p>

              <p id="selectedServiceText">Loading...</p>
            </div>

            <form id="bookingForm">
              <div class="form-group">
                <label for="customerName">Your Full Name</label>
                <input
                  type="text"
                  id="customerName"
                  name="customerName"
                  placeholder="Enter your name"
                  required
                />
              </div>

              <div class="form-group">
                <label for="customerPhone">Phone Number</label>
                <input
                  type="tel"
                  id="customerPhone"
                  name="customerPhone"
                  placeholder="Enter your phone number"
                  required
                />
              </div>

              <div class="form-group">
                <label for="customerAddress">Address</label>
                <div class="address-input-group">
                  <textarea
                    id="customerAddress"
                    name="customerAddress"
                    rows="1"
                    placeholder="Enter your address"
                    required
                  ></textarea>
                  <button
                    type="button"
                    class="btn auto-detect-btn"
                    id="autoDetectBtn"
                  >
                    Auto-Detect Location üìç
                  </button>
                </div>
              </div>

              <div class="form-group">
                <label for="customerPincode">Pincode</label>
                <input
                  type="text"
                  id="customerPincode"
                  name="customerPincode"
                  placeholder="Enter your area pincode"
                  required
                />
              </div>

              <input type="hidden" id="deviceType" name="deviceType" />

              <div class="form-group">
                <label for="problemDescription"
                  >Problem Description (Optional)</label
                >
                <textarea
                  id="problemDescription"
                  name="problemDescription"
                  rows="4"
                  placeholder="Please describe the issue in detail"
                ></textarea>
              </div>

              <div class="form-group payment-options">
                <label class="accordion-header" for="paymentMethodAccordion"
                  >Payment Method</label
                >
                <div class="accordion-container" id="paymentMethodAccordion">
                  <div class="accordion-item">
                    <div
                      class="accordion-title"
                      id="advanceTitle"
                      data-payment="advance"
                    >
                      <label for="advancePaymentOption" class="accordion-label">
                        Pay in Advance (Online)
                      </label>
                      <span class="accordion-icon"
                        ><i class="fas fa-chevron-down"></i
                      ></span>
                    </div>
                    <div class="accordion-content">
                      <p>
                        By paying in advance, you can confirm your booking
                        instantly and get priority service. You will be
                        redirected to a secure payment page.
                      </p>
                      <button
                        type="submit"
                        class="btn submit-btn"
                        data-payment="advance"
                      >
                        Proceed to Pay
                      </button>
                    </div>
                  </div>
                  <div class="accordion-item">
                    <div
                      class="accordion-title"
                      id="afterServiceTitle"
                      data-payment="after-service"
                    >
                      <label for="afterServiceOption" class="accordion-label">
                        Pay After Service (Cash/Online)
                      </label>
                      <span class="accordion-icon"
                        ><i class="fas fa-chevron-down"></i
                      ></span>
                    </div>
                    <div class="accordion-content">
                      <p>
                        You can book your service now and pay the technician
                        directly after the service is completed. We accept both
                        cash and online payments.
                      </p>
                      <button
                        type="submit"
                        class="btn submit-btn"
                        data-payment="after-service"
                      >
                        Book Now
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </section>

    <div id="authModal" class="modal">
      <div class="modal-content">
        <h3>You must be logged in to book a service.</h3>
        <p>Please log in or create an account to continue.</p>
        <div class="modal-buttons">
          <a href="../html/login.html" class="btn login-btn">Log In</a>
          <a href="../html/signup.html" class="btn signup-btn">Sign Up</a>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
      import {
        getDatabase,
        ref,
        get,
        child,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

      // üîπ Firebase Config
      const firebaseConfig = {
        apiKey: "AIzaSyCQneRn2fhr2MBPZ8FpGYQTHnSVXe-Y8oQ",
        authDomain: "electrofix-website.firebaseapp.com",
        projectId: "electrofix-website",
        storageBucket: "electrofix-website.appspot.com",
        messagingSenderId: "891241046906",
        appId: "1:891241046906:web:382d83e91f521a357cacc3",
        databaseURL:
          "https://electrofix-website-default-rtdb.asia-southeast1.firebasedatabase.app/",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getDatabase(app);

      // üîπ Map for service categories
      const categoryMap = {
        ac: {
          displayName: "AC Repair & Services",
          services: {
            general: "General Services",
            installation: "Installation & Uninstallation",
            cooling: "Cooling / Performance Issues",
            gas: "Gas & Refrigerant Works",
            electrical: "Electrical & Wiring Repairs",
            compressor: "Compressor Works",
            "water-leakage": "Water Leakage Problems",
            motor: "Fan & Motor Services",
            noise: "Noise & Vibration Issues",
            remote: "Remote & Sensor Issues",
            "deep-cleaning": "Deep Cleaning Services",
            specialized: "Specialized AC Services",
            "value-added": "Value-Added Services",
          },
        },
        "washing-machine": {
          displayName: "Washing Machine Services",
          services: {
            general: "General Services",
            installation: "Installation & Uninstallation",
            washing: "Washing Issues",
            "spin-dry": "Spin & Dry Problems",
            water: "Water Supply & Drainage",
            electrical: "Electrical & Control Issues",
            motor: "Motor & Mechanical Repairs",
            "door-body": "Door & Body Repairs",
            specialized: "Specialized Works",
            "value-added": "Value-Added Services",
          },
        },
        wm: {
          displayName: "Washing Machine Services",
          services: {
            general: "General Services",
            installation: "Installation & Uninstallation",
            washing: "Washing Issues",
            "spin-dry": "Spin & Dry Problems",
            water: "Water Supply & Drainage",
            electrical: "Electrical & Control Issues",
            motor: "Motor & Mechanical Repairs",
            "door-body": "Door & Body Repairs",
            specialized: "Specialized Works",
            "value-added": "Value-Added Services",
          },
        },
        "sewing-machine": {
          displayName: "Sewing Machine Services",
          services: {
            general: "General Services",
            installation: "Installation & Setup",
            stitching: "Stitching Issues",
            mechanical: "Mechanical Repairs",
            electrical: "Electrical Repairs (for Motorized Machines)",
            specialized: "Specialized Services",
            performance: "Performance Issues",
            "spare-parts": "Spare Parts & Replacement",
            "value-added": "Value-Added Services",
          },
        },
        computer: {
          displayName: "Computer Services",
          services: {
            general: "General Services",
            software: "Software Installation & Support",
            virus: "Virus & Security",
            hardware: "Hardware Repair & Replacement",
            peripherals: "Peripheral & Accessory Services",
            networking: "Networking Services",
            data: "Data Services",
            laptop: "Laptop-Specific Services",
            upgrades: "Customization & Upgrades",
            "it-support": "IT Support & Maintenance",
          },
        },
      };

      // ‚úÖ ‡¶®‡¶§‡ßÅ‡¶® ‡¶´‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶ó ‡¶≠‡ßá‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶¨‡¶≤
      let authCheckCompleted = false;

      // üîπ Load user and service details
      onAuthStateChanged(auth, async (user) => {
        const authModal = document.getElementById("authModal");
        const bookingSection = document.querySelector(".booking-section");

        if (!user) {
          if (!authCheckCompleted) {
            authModal.style.display = "flex";
            bookingSection.classList.add("blur");
            authCheckCompleted = true;
          }
          return;
        }

        authModal.style.display = "none";
        bookingSection.classList.remove("blur");
        authCheckCompleted = true;

        const uid = user.uid;
        const dbRef = ref(db);
        const customerPhoneInput = document.getElementById("customerPhone");
        const countryCode = "+91 ";

        customerPhoneInput.value = countryCode;

        customerPhoneInput.addEventListener("keydown", (e) => {
          const isAtStart =
            customerPhoneInput.selectionStart <= countryCode.length;
          const isBackspaceOrDelete =
            e.key === "Backspace" || e.key === "Delete";
          if (isBackspaceOrDelete && isAtStart) {
            e.preventDefault();
          }
        });

        customerPhoneInput.addEventListener("input", () => {
          if (!customerPhoneInput.value.startsWith(countryCode)) {
            customerPhoneInput.value = countryCode;
          }
        });

        try {
          const snapshot = await get(child(dbRef, `users/${uid}`));
          if (snapshot.exists()) {
            const userData = snapshot.val();
            console.log("‚úÖ User data loaded:", userData);

            document.getElementById("customerName").value =
              userData.fullName ?? "";
            document.getElementById("customerPhone").value =
              (userData.phoneNumber
                ? userData.phoneNumber.replace(/^\+91\s?/, "")
                : "") ?? "";
            customerPhoneInput.value = countryCode + customerPhoneInput.value;
            document.getElementById("customerAddress").value =
              userData.address ?? "";
            document.getElementById("customerPincode").value =
              userData.postalCode ?? "";
          } else {
            console.warn("‚ö†Ô∏è User profile not found in database!");
          }
        } catch (error) {
          console.error("‚ùå Error loading profile:", error);
        }

        // üîπ Read service details from URL
        const urlParams = new URLSearchParams(window.location.search);
        const categoryKey = (urlParams.get("category") || "").toLowerCase();
        const serviceKey = (urlParams.get("service") || "").toLowerCase();

        const categoryData = categoryMap[categoryKey];
        let categoryText = "Unknown Device";
        let serviceText = "Unknown Service";

        if (categoryData) {
          categoryText = categoryData.displayName;
          serviceText = categoryData.services[serviceKey] || "Unknown Service";
        }

        const categoryTextEl = document.getElementById("selectedCategoryText");
        const serviceTextEl = document.getElementById("selectedServiceText");

        if (categoryTextEl) categoryTextEl.innerText = categoryText;
        if (serviceTextEl) serviceTextEl.innerText = serviceText;

        const deviceTypeInput = document.getElementById("deviceType");
        if (deviceTypeInput)
          deviceTypeInput.value = `${categoryText} > ${serviceText}`;
      });

      // Click outside modal closes it
      window.addEventListener("click", (e) => {
        const authModal = document.getElementById("authModal");
        if (e.target === authModal) {
          authModal.style.display = "none";
          window.location.href = "../index.html";
        }
      });
    </script>

    <script type="module" src="../js/booking.js"></script>
    <script src="../js/auth.js"></script>
  </body>
</html>
