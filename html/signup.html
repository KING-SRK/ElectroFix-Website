<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sign Up</title>
    <link rel="stylesheet" href="../css/signup.css" />
    <link rel="stylesheet" href="../css/validation.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
  </head>
  <body>
    <div class="loader-container">
      <div class="loader-content">
        <i class="fas fa-spinner fa-spin loader-icon"></i>
        <p class="loader-text">Processing...</p>
      </div>
    </div>

    <div class="signup-container">
      <div class="signup-card">
        <div class="card-header">
          <i class="fas fa-user-plus"></i>
          <h2>Create Your Account</h2>
          <p>Sign up to get started with our services.</p>
        </div>
        <form class="signup-form">
          <div class="input-group">
            <label for="fullName">Full Name</label>
            <input
              type="text"
              id="fullName"
              placeholder="Enter your full name"
              required
            />
          </div>

          <div class="input-group">
            <label for="phoneNumber">Phone Number</label>
            <input
              type="tel"
              id="phoneNumber"
              placeholder="Enter your phone number (e.g., 9876543210)"
              required
            />
            <span class="error-message" id="phone-error"></span>
          </div>

          <div class="input-group">
            <label for="email">Email Address</label>
            <input
              type="email"
              id="email"
              placeholder="Enter your email"
              required
            />
            <span class="error-message" id="email-error"></span>
          </div>

          <div class="input-group">
            <label for="password">Password</label>
            <input
              type="password"
              id="password"
              placeholder="Create a strong password"
              required
            />
            <span class="error-message" id="password-error"></span>
          </div>

          <div class="input-group">
            <label for="address">Address</label>
            <div class="address-group">
              <textarea
                id="address"
                placeholder="Enter your address"
                rows="1"
                required
              ></textarea>
              <button
                type="button"
                class="fill-address-btn"
                onclick="fillAddress()"
              >
                Use My Location
              </button>
            </div>
          </div>

          <div class="input-group">
            <label for="postalCode">PIN Code</label>
            <input
              type="text"
              id="postalCode"
              placeholder="Enter your pin code"
              required
            />
          </div>

          <button type="submit" class="signup-btn">Sign Up</button>
        </form>
        <div class="login-link">
          Already have an account? <a href="login.html">Log In</a>
        </div>
      </div>
    </div>

    <div class="modal-backdrop"></div>
    <div class="success-modal">
      <div class="modal-content">
        <i class="fas fa-check-circle success-icon"></i>
        <h3>Signup Successful!</h3>
        <p>Your account has been created successfully. Redirecting...</p>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getAuth,
        createUserWithEmailAndPassword,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
      import {
        getDatabase,
        ref,
        set,
        update,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

      // ðŸ”¹ Firebase Config
      const firebaseConfig = {
        apiKey: "AIzaSyCQneRn2fhr2MBPZ8FpGYQTHnSVXe-Y8oQ",
        authDomain: "electrofix-website.firebaseapp.com",
        projectId: "electrofix-website",
        storageBucket: "electrofix-website.appspot.com",
        messagingSenderId: "891241046906",
        appId: "1:891241046906:web:382d83e91f521a357cacc3",
        measurementId: "G-MCWKF1FNE1",
      };

      // ðŸ”¹ Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);

      // Database with explicit URL
      const database = getDatabase(
        app,
        "https://electrofix-website-default-rtdb.asia-southeast1.firebasedatabase.app/"
      );

      // ðŸ”¹ Get modal and loader elements
      const modalBackdrop = document.querySelector(".modal-backdrop");
      const successModal = document.querySelector(".success-modal");
      const loaderContainer = document.querySelector(".loader-container");
      const addressInput = document.getElementById("address"); // âœ… à¦¨à¦¤à§à¦¨ à¦²à¦¾à¦‡à¦¨
      const signupForm = document.querySelector(".signup-form"); // âœ… à¦¨à¦¤à§à¦¨ à¦²à¦¾à¦‡à¦¨

      function showLoader(message = "Processing...") {
        document.querySelector(".loader-text").innerText = message;
        loaderContainer.style.display = "flex";
      }

      function hideLoader() {
        loaderContainer.style.display = "none";
      }

      function showSuccessPopup() {
        modalBackdrop.style.display = "block";
        successModal.style.display = "block";
      }

      // âœ… à¦¨à¦¤à§à¦¨ à¦…à¦Ÿà§‹-à¦°à¦¿-à¦¸à¦¾à¦‡à¦œ à¦«à¦¾à¦‚à¦¶à¦¨
      function autoResizeTextarea() {
        addressInput.style.height = "auto";
        addressInput.style.height = addressInput.scrollHeight + "px";
      }

      // ðŸ”¹ Validation Functions
      const showError = (element, message) => {
        const parent = element.parentElement;
        parent.classList.add("invalid");
        const errorSpan = parent.querySelector(".error-message");
        if (errorSpan) {
          errorSpan.textContent = message;
          errorSpan.style.display = "block";
        }
      };

      const clearError = (element) => {
        const parent = element.parentElement;
        parent.classList.remove("invalid");
        const errorSpan = parent.querySelector(".error-message");
        if (errorSpan) {
          errorSpan.textContent = "";
          errorSpan.style.display = "none";
        }
      };

      const validatePhone = (phone) => {
        const phoneRegex = /^[6789]\d{9}$/;
        if (!phoneRegex.test(phone)) {
          showError(
            document.getElementById("phoneNumber"),
            "Phone number must be 10 digits and start with 6, 7, 8, or 9."
          );
          return false;
        }
        clearError(document.getElementById("phoneNumber"));
        return true;
      };

      const validateEmail = (email) => {
        const emailRegex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}$/;
        if (!emailRegex.test(email)) {
          showError(
            document.getElementById("email"),
            "Please enter a valid email address."
          );
          return false;
        }
        clearError(document.getElementById("email"));
        return true;
      };

      const validatePassword = (password) => {
        const errors = [];
        if (password.length < 8) {
          errors.push("at least 8 characters long");
        }
        if (!/[A-Z]/.test(password)) {
          errors.push("at least one uppercase letter (A-Z)");
        }
        if (!/[a-z]/.test(password)) {
          errors.push("at least one lowercase letter (a-z)");
        }
        if (!/[0-9]/.test(password)) {
          errors.push("at least one number (0-9)");
        }
        if (!/[!@#$%&*?]/.test(password)) {
          errors.push("at least one special character (!, @, #, $, etc.)");
        }

        if (errors.length > 0) {
          showError(
            document.getElementById("password"),
            `Password must contain: ${errors.join(", ")}.`
          );
          return false;
        }
        clearError(document.getElementById("password"));
        return true;
      };

      // ðŸ”¹ Add real-time validation and resize listeners
      document
        .getElementById("phoneNumber")
        .addEventListener("keyup", (e) => validatePhone(e.target.value));
      document
        .getElementById("email")
        .addEventListener("keyup", (e) => validateEmail(e.target.value));
      document
        .getElementById("password")
        .addEventListener("keyup", (e) => validatePassword(e.target.value));
      document
        .getElementById("address")
        .addEventListener("input", autoResizeTextarea); // âœ… à¦¨à¦¤à§à¦¨ à¦²à¦¿à¦¸à§‡à¦¨à¦¾à¦°

      // Also validate when a user clicks away from the field
      document
        .getElementById("phoneNumber")
        .addEventListener("blur", (e) => validatePhone(e.target.value));
      document
        .getElementById("email")
        .addEventListener("blur", (e) => validateEmail(e.target.value));
      document
        .getElementById("password")
        .addEventListener("blur", (e) => validatePassword(e.target.value));

      // ðŸ”¹ Form submit
      signupForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        // ðŸ”¹ Get all form values
        const fullName = document.getElementById("fullName").value.trim();
        const phoneNumber = document.getElementById("phoneNumber").value.trim();
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value;
        const address = document.getElementById("address").value.trim();
        const postalCode = document.getElementById("postalCode").value.trim();

        // ðŸ”¹ Run all validations before proceeding
        const isPhoneValid = validatePhone(phoneNumber);
        const isEmailValid = validateEmail(email);
        const isPasswordValid = validatePassword(password);

        // If any validation fails, stop the process
        if (!isPhoneValid || !isEmailValid || !isPasswordValid) {
          return;
        }

        // ðŸ”¹ Final check for all fields
        if (
          !fullName ||
          !phoneNumber ||
          !email ||
          !password ||
          !address ||
          !postalCode
        ) {
          alert("Please fill all fields!");
          return;
        }

        showLoader("Creating your account...");

        try {
          // ðŸ”¹ Create user with email and password
          const userCredential = await createUserWithEmailAndPassword(
            auth,
            email,
            password
          );
          const user = userCredential.user;

          console.log("User UID:", user.uid);

          // ðŸ”¹ Save all user info in Realtime Database
          await set(ref(database, "users/" + user.uid), {
            fullName,
            phoneNumber,
            email,
            address,
            postalCode,
            location: {
              latitude: window.userLat || null,
              longitude: window.userLon || null,
            },
            createdAt: new Date().toISOString(),
          });

          hideLoader();
          showSuccessPopup();

          localStorage.setItem("loggedIn", "true");
          localStorage.setItem("uid", user.uid); // âœ… à¦¨à¦¤à§à¦¨ à¦²à¦¾à¦‡à¦¨
          localStorage.setItem("userName", fullName);
          localStorage.setItem("userAddress", address);

          setTimeout(() => {
            signupForm.reset();
            window.location.href = "../index.html";
          }, 3000);
        } catch (error) {
          hideLoader();
          console.error("Firebase Operation Failed:", error);

          let errorMessage = "An unknown error occurred. Please try again.";
          switch (error.code) {
            case "auth/email-already-in-use":
              errorMessage =
                "This email is already registered. Please log in or use a different email.";
              break;
            case "auth/invalid-email":
              errorMessage = "The email address is not valid.";
              break;
            case "auth/weak-password":
              errorMessage =
                "The password is too weak. Please use at least 6 characters.";
              break;
            case "permission-denied":
              errorMessage =
                "Database write permission denied. Check your database rules.";
              break;
            default:
              errorMessage = error.message;
              break;
          }
          alert("Error: " + errorMessage);
        }
      });

      // ðŸ”¹ Address autofill + realtime save
      window.fillAddress = function () {
        if (!navigator.geolocation) {
          alert("Geolocation is not supported by your browser.");
          return;
        }

        showLoader("Fetching your location...");

        navigator.geolocation.getCurrentPosition(
          async (position) => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;

            // ðŸ”¹ save globally
            window.userLat = lat;
            window.userLon = lon;

            try {
              const res = await fetch(
                `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`
              );
              const data = await res.json();
              const address = data.display_name || `${lat}, ${lon}`;
              const postalCode = data.address.postcode || "";

              // input field à¦ à¦¬à¦¸à¦¾à¦“
              addressInput.value = address;
              document.getElementById("postalCode").value = postalCode;

              // âœ… à¦à¦–à¦¾à¦¨à§‡ à¦…à¦Ÿà§‹-à¦°à¦¿-à¦¸à¦¾à¦‡à¦œ à¦«à¦¾à¦‚à¦¶à¦¨ à¦•à¦² à¦•à¦°à¦¾ à¦¹à¦šà§à¦›à§‡
              autoResizeTextarea();

              // ðŸ”¹ à¦¯à¦¦à¦¿ à¦‡à¦¤à¦¿à¦®à¦§à§à¦¯à§‡ à¦‡à¦‰à¦œà¦¾à¦° à¦²à¦—à¦‡à¦¨ à¦•à¦°à¦¾ à¦¥à¦¾à¦•à§‡ à¦¤à¦¬à§‡ à¦¸à¦¾à¦¥à§‡ à¦¸à¦¾à¦¥à§‡ DB à¦¤à§‡ à¦¸à§‡à¦­ à¦•à¦°à§‹
              const currentUser = auth.currentUser;
              if (currentUser) {
                await update(ref(database, "users/" + currentUser.uid), {
                  address: address,
                  postalCode: postalCode,
                  location: {
                    latitude: lat,
                    longitude: lon,
                  },
                  updatedAt: new Date().toISOString(),
                });
                console.log("ðŸ“ Location and postal code saved in database âœ…");
              }
            } catch {
              addressInput.value = `${lat}, ${lon}`;
            } finally {
              hideLoader();
            }
          },
          () => {
            hideLoader();
            alert("Unable to fetch location. Please allow location access.");
          }
        );
      };
    </script>
  </body>
</html>
